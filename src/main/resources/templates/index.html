<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aloy - Apartment Rental System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">Aloy</a>
        <div class="navbar-nav ms-auto" id="navbarUserInfo">
            <!-- User info or login/register buttons will be rendered here by JS -->
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h1>Find Your Perfect Apartment</h1>
            <p class="lead">Browse hundreds of apartments for rent in your desired location</p>

            <!-- Search Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Search Apartments</h5>
                    <form id="searchForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <input type="text" class="form-control" id="district" placeholder="District">
                            </div>
                            <div class="col-md-4 mb-3">
                                <input type="number" class="form-control" id="minPrice" placeholder="Min Price">
                            </div>
                            <div class="col-md-4 mb-3">
                                <input type="number" class="form-control" id="maxPrice" placeholder="Max Price">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Search</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetSearch()">Reset</button>
                    </form>
                </div>
            </div>

                        <!-- Apartments Container -->
                        <div id="apartmentsContainer" class="row">
                                <!-- Apartments will be loaded here by JavaScript -->
                        </div>

                        <!-- Apartment Details Modal -->
                        <div class="modal fade" id="apartmentDetailsModal" tabindex="-1" aria-labelledby="apartmentDetailsModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="apartmentDetailsModalLabel">Apartment Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" id="apartmentDetailsModalBody">
                                        <!-- Details will be loaded here by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>

                <!-- Add Apartment Form (Owner) -->
                <div id="addApartmentCard"></div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Quick Stats</h5>
                </div>
                <div class="card-body">
                    <p><strong>Total Apartments:</strong> <span id="totalApartments">0</span></p>
                    <p><strong>Average Price:</strong> $<span id="avgPrice">0</span></p>
                    <p><strong>Most Popular District:</strong> <span id="popularDistrict">-</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/app.js"></script>
<script>
// Render navbar user info or login/register
function renderNavbarUserInfo() {
    const user = JSON.parse(localStorage.getItem('user'));
    const navbar = document.getElementById('navbarUserInfo');
    if (user && user.name && user.role) {
        navbar.innerHTML = `<span class="nav-link">ID: ${user.userId} | ${user.name} (${user.role})</span>
            <a class="nav-link" href="#" onclick="logoutUser()">Logout</a>`;
    } else {
        navbar.innerHTML = `<a class="nav-link" href="/login">Login</a>
            <a class="nav-link" href="/register">Register</a>`;
    }
}

function logoutUser() {
    localStorage.removeItem('user');
    location.reload();
}

// Conditionally render Add Apartment form for owners
function renderAddApartmentForm() {
    const user = JSON.parse(localStorage.getItem('user'));
    const container = document.getElementById('addApartmentCard');
    if (user && user.role === 'owner') {
        container.innerHTML = `
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5>Add Apartment (Owner)</h5>
                </div>
                <div class="card-body">
                    <form id="addApartmentForm">
                        <div class="mb-2">
                            <input type="text" class="form-control" id="aptTitle" placeholder="Title" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="aptDescription" placeholder="Description" required>
                        </div>
                        <div class="mb-2">
                            <input type="number" class="form-control" id="aptMonthlyRate" placeholder="Monthly Rate" required>
                        </div>
                        <div class="mb-2">
                            <input type="date" class="form-control" id="aptAvailability" placeholder="Availability" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="aptDistrict" placeholder="District" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="aptStreet" placeholder="Street" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="aptHouseNo" placeholder="House No" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="aptAddress" placeholder="Full Address" required>
                        </div>
                        <div class="mb-2">
                            <select class="form-control" id="aptAllowedFor" required>
                                <option value="solo">Solo</option>
                                <option value="group">Group</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Add Apartment</button>
                    </form>
                    <div id="addApartmentMsg" class="mt-2"></div>
                </div>
            </div>
        `;
        document.getElementById('addApartmentForm').onsubmit = function(e) {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('user'));
            const data = {
                title: document.getElementById('aptTitle').value,
                description: document.getElementById('aptDescription').value,
                monthlyRate: parseFloat(document.getElementById('aptMonthlyRate').value),
                availability: document.getElementById('aptAvailability').value,
                district: document.getElementById('aptDistrict').value,
                street: document.getElementById('aptStreet').value,
                houseNo: document.getElementById('aptHouseNo').value,
                address: document.getElementById('aptAddress').value,
                allowedFor: document.getElementById('aptAllowedFor').value,
                ownerId: user.userId
            };
            fetch('/api/apartments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(resp => {
                document.getElementById('addApartmentMsg').innerHTML = '<span class="text-success">Apartment added!</span>';
            })
            .catch(() => {
                document.getElementById('addApartmentMsg').innerHTML = '<span class="text-danger">Failed to add apartment.</span>';
            });
        };
    } else {
        container.innerHTML = '';
    }
}

// Helper to show apartment details in modal
function showApartmentDetailsModal(apartmentId) {
    fetch(`/api/apartments/${apartmentId}`)
        .then(response => response.json())
        .then(apartment => {
            // Check if apartment is booked
            const isBooked = apartment.booked || apartment.status === 'RENTED';
            const statusBadge = isBooked 
                ? '<span class="badge bg-danger fs-6">ALREADY BOOKED</span>' 
                : '<span class="badge bg-success fs-6">AVAILABLE</span>';
            
            let bookingSection = '';
            if (isBooked) {
                bookingSection = `
                    <div class="alert alert-warning mt-3" role="alert">
                        <h5 class="alert-heading">⚠️ This apartment is already booked!</h5>
                        <p>Unfortunately, this property has already been rented to another tenant.</p>
                        <hr>
                        <button class="btn btn-primary" onclick="location.reload()">Browse Other Available Apartments</button>
                    </div>
                `;
            } else {
                const allowedFor = apartment.allowedFor || 'both';
                let buttons = '';
                
                // Show solo button if allowed
                if (allowedFor === 'solo' || allowedFor === 'both') {
                    buttons += `<button class="btn btn-success" id="bookSoloBtn" data-apartment-id="${apartment.apartmentId}" data-amount="${apartment.monthlyRate}">Book for Myself</button>`;
                }
                
                // Show group button if allowed
                if (allowedFor === 'group' || allowedFor === 'both') {
                    buttons += `<button class="btn btn-info ms-2" id="bookGroupBtn" data-apartment-id="${apartment.apartmentId}" data-amount="${apartment.monthlyRate}">Book in a Group</button>`;
                }
                
                bookingSection = `<div class="d-flex gap-2 mt-3">${buttons}</div>`;
            }
            
            let html = `
                <img src="https://placehold.co/800x400/4f46e5/ffffff?text=${encodeURIComponent(apartment.title)}" class="img-fluid mb-3" alt="${apartment.title}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">${apartment.title}</h3>
                    ${statusBadge}
                </div>
                <p><strong>Description:</strong> ${apartment.description || 'No description available'}</p>
                <ul class="list-group mb-3">
                    <li class="list-group-item"><strong>Location:</strong> ${apartment.address || 'N/A'}</li>
                    <li class="list-group-item"><strong>District:</strong> ${apartment.district || 'N/A'}</li>
                    <li class="list-group-item"><strong>Available from:</strong> ${formatDate(apartment.availability) || 'N/A'}</li>
                    <li class="list-group-item"><strong>Suitable for:</strong> ${apartment.allowedFor === 'solo' ? 'Solo' : (apartment.allowedFor === 'group' ? 'Group' : (apartment.allowedFor === 'both' ? 'Both (Solo & Group)' : 'N/A'))}</li>
                    <li class="list-group-item"><strong>Monthly Rate:</strong> $${apartment.monthlyRate}</li>
                    <li class="list-group-item"><strong>Status:</strong> ${isBooked ? '<span class="text-danger fw-bold">RENTED</span>' : '<span class="text-success fw-bold">AVAILABLE</span>'}</li>
                </ul>
                <p><strong>Owner ID:</strong> ${apartment.ownerId || 'N/A'}</p>
                ${bookingSection}
                <div id="paymentModalContainer"></div>
                <div id="groupModalContainer"></div>
            `;
            document.getElementById('apartmentDetailsModalBody').innerHTML = html;
            var modal = new bootstrap.Modal(document.getElementById('apartmentDetailsModal'));
            modal.show();
        })
        .catch(() => {
            document.getElementById('apartmentDetailsModalBody').innerHTML = '<div class="alert alert-danger">Error loading apartment details.</div>';
            var modal = new bootstrap.Modal(document.getElementById('apartmentDetailsModal'));
            modal.show();
        });
}

// Patch displayApartments to use modal
window.displayApartments = function(apartments) {
    const container = document.getElementById('apartmentsContainer');
    if (!container) return;
    if (apartments.length === 0) {
        container.innerHTML = '<div class="no-results"><h3>No apartments found</h3><p>Try adjusting your search criteria.</p></div>';
        return;
    }
    let html = '<div class="row">';
    apartments.forEach(apartment => {
        // Check if apartment is booked
        const isBooked = apartment.booked || apartment.status === 'RENTED';
        const statusBadge = isBooked ? '<span class="badge bg-danger">BOOKED</span>' : '<span class="badge bg-success">AVAILABLE</span>';
        
        html += `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card apartment-card h-100">
                <img src="https://placehold.co/600x400/4f46e5/ffffff?text=${encodeURIComponent(apartment.title)}" class="card-img-top" alt="${apartment.title}">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="price-tag">$${apartment.monthlyRate}/month</div>
                        ${statusBadge}
                    </div>
                    <h5 class="card-title">${apartment.title}</h5>
                    <p class="card-text">${apartment.description || 'No description available'}</p>
                    <div class="mt-auto">
                        <p class="mb-1"><strong>Location:</strong> ${apartment.district || 'N/A'}</p>
                        <p class="mb-1"><strong>Available from:</strong> ${formatDate(apartment.availability) || 'N/A'}</p>
                        <button class="btn btn-primary" onclick="showApartmentDetailsModal(${apartment.apartmentId})">View Details</button>
                    </div>
                </div>
            </div>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Check if we're returning from a payment success (force refresh apartments)
function checkForPaymentRefresh() {
    const urlParams = new URLSearchParams(window.location.search);
    const hasRefreshParam = urlParams.has('refresh');
    const hasLocalFlag = (function(){ try { return localStorage.getItem('paymentRefresh') === 'true'; } catch(e){ return false; } })();

    if (hasRefreshParam || hasLocalFlag) {
        console.log('Detected payment success (param or local flag) - forcing apartment list refresh with cache bypass');
        // Force refresh apartments from API with cache-busting
        fetch('/api/apartments?nocache=' + Date.now(), {
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        })
        .then(response => response.json())
        .then(apartments => {
            displayApartments(apartments);
            if (typeof calculateStats === 'function') calculateStats(apartments);
            // Clean URL without page reload
            try { window.history.replaceState({}, document.title, window.location.pathname); } catch(e){}
            // Clear localStorage flag if set
            try { localStorage.removeItem('paymentRefresh'); } catch(e){}
        })
        .catch(error => console.error('Error refreshing apartments:', error));
    }
}

// On page load
renderNavbarUserInfo();
renderAddApartmentForm();
checkForPaymentRefresh();
</script>
</body>
</html>